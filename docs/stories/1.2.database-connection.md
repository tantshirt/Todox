# Story 1.2: Database Connection & User Model

## Status
Ready for Review

## Story

**As a** developer,  
**I want** MongoDB Atlas connection established with a User model,  
**so that** we can persist user data securely and query it efficiently.

## Acceptance Criteria

1. MongoDB Atlas cluster is provisioned and connection string available
2. Backend has database client module (`db/client.py`) with connection pooling configured
3. User Pydantic model defined with fields: id, email, hashed_password, created_at, updated_at
4. User repository class (`db/repositories/users_repo.py`) implements methods: create_user, find_by_email, find_by_id
5. Database connection health check endpoint (`GET /health`) returns 200 with database status
6. Unit tests verify User model validation and repository methods using test database
7. Environment variable `MONGODB_URI` properly loads from `.env`

## Tasks / Subtasks

- [ ] Task 1: Provision MongoDB Atlas cluster (User Action) (AC: 1)
  - [ ] User creates free M0 cluster on MongoDB Atlas (https://www.mongodb.com/cloud/atlas/register)
  - [ ] User configures network access (add current IP or 0.0.0.0/0 for development)
  - [ ] User creates database user with username/password
  - [ ] User obtains connection string and adds to `backend/.env` as `MONGODB_URI`
  
- [x] Task 2: Create database client module (AC: 2, 7)
  - [x] Create `backend/src/core/database.py`
  - [x] Implement `get_database()` function that returns AsyncIOMotorDatabase instance
  - [x] Configure Motor client with connection pooling (max_pool_size=10, min_pool_size=1)
  - [x] Load `MONGODB_URI` from environment via `src/core/config.py`
  - [x] Implement startup event in `main.py` to test database connection
  - [x] Implement shutdown event to close database connection
  
- [x] Task 3: Define User Pydantic model (AC: 3)
  - [x] Create `backend/src/models/user.py`
  - [x] Define `UserBase` Pydantic model with: email (EmailStr, required)
  - [x] Define `UserCreate` schema with: email, password (min 8 chars)
  - [x] Define `UserInDB` model extending UserBase with: id (str), hashed_password (str), created_at (datetime), updated_at (datetime)
  - [x] Define `UserResponse` model (excludes hashed_password) for API responses
  - [x] Add field validators for email format and password strength
  
- [x] Task 4: Implement User repository (AC: 4)
  - [x] Create `backend/src/repositories/user_repository.py`
  - [x] Implement `UserRepository` class with `__init__(self, db: AsyncIOMotorDatabase)`
  - [x] Implement `async def create_user(self, email: str, hashed_password: str) -> UserInDB`
  - [x] Implement `async def find_by_email(self, email: str) -> Optional[UserInDB]`
  - [x] Implement `async def find_by_id(self, user_id: ObjectId) -> Optional[UserInDB]`
  - [x] Ensure all methods set created_at and updated_at timestamps
  - [x] Create unique index on email field in users collection
  
- [x] Task 5: Create health check endpoint (AC: 5)
  - [x] Create or update `backend/src/api/v1/health.py` (or add to `main.py`)
  - [x] Implement `GET /health` endpoint that returns: `{"status": "healthy", "database": "connected"}`
  - [x] Endpoint should ping MongoDB to verify connection (try a simple query)
  - [x] Return 503 Service Unavailable if database connection fails
  - [x] No authentication required for health check
  
- [x] Task 6: Write unit tests for User model and repository (AC: 6)
  - [x] Create `backend/tests/conftest.py` with pytest fixtures
  - [x] Add fixture for test MongoDB database (separate from production)
  - [x] Add fixture for test client (httpx.AsyncClient)
  - [x] Create `backend/tests/test_user_model.py`
    - [x] Test User model validation (valid email, invalid email, short password)
    - [x] Test UserInDB creation with all fields
  - [x] Create `backend/tests/test_user_repository.py`
    - [x] Test create_user inserts document and returns UserInDB
    - [x] Test find_by_email finds existing user
    - [x] Test find_by_email returns None for non-existent email
    - [x] Test find_by_id finds user by ObjectId
    - [x] Test email uniqueness (duplicate insert fails)

## Dev Notes

### Database Connection Setup

**[Source: docs/architecture/database-schema.md]**

The users collection is the first collection to be created in MongoDB. It stores user authentication credentials and metadata.

**MongoDB Connection Configuration:**
- Use Motor (async MongoDB driver) version 3.3+
- Connection string format: `mongodb+srv://username:password@cluster.mongodb.net/todox?retryWrites=true&w=majority`
- Enable connection pooling with max_pool_size=10, min_pool_size=1
- Database name: `todox` (or configurable via environment)

**Users Collection Schema:**
```json
{
  "_id": ObjectId,
  "email": "user@example.com",
  "hashed_password": "$2b$12$...",
  "created_at": ISODate,
  "updated_at": ISODate
}
```

**Required Indexes:**
- Unique index on `email` field (prevents duplicate registrations)
- Primary key on `_id` (automatic)

### User Data Model

**[Source: docs/architecture/data-models.md#User]**

**Pydantic Models to Create:**

```python
from pydantic import BaseModel, EmailStr, Field
from datetime import datetime
from typing import Optional

class UserBase(BaseModel):
    email: EmailStr

class UserCreate(BaseModel):
    email: EmailStr
    password: str = Field(min_length=8)

class UserInDB(UserBase):
    id: str
    hashed_password: str
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True  # For Pydantic v2

class UserResponse(UserBase):
    id: str
    created_at: datetime
    updated_at: datetime
```

**Key Validations:**
- Email must be valid format (use EmailStr type)
- Password minimum 8 characters
- Never expose hashed_password in responses

### Repository Pattern

**[Source: docs/architecture/backend-architecture.md#Database Architecture]**

All database operations must go through repository classes. Never call MongoDB client directly in services or routes.

**UserRepository Implementation Pattern:**

```python
from motor.motor_asyncio import AsyncIOMotorDatabase
from bson import ObjectId
from datetime import datetime
from typing import Optional

class UserRepository:
    def __init__(self, db: AsyncIOMotorDatabase):
        self.collection = db.users
    
    async def create_user(self, email: str, hashed_password: str) -> UserInDB:
        user_data = {
            "email": email,
            "hashed_password": hashed_password,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        }
        result = await self.collection.insert_one(user_data)
        user_data["_id"] = result.inserted_id
        return UserInDB(
            id=str(user_data["_id"]),
            email=user_data["email"],
            hashed_password=user_data["hashed_password"],
            created_at=user_data["created_at"],
            updated_at=user_data["updated_at"]
        )
    
    async def find_by_email(self, email: str) -> Optional[UserInDB]:
        user = await self.collection.find_one({"email": email})
        if not user:
            return None
        return UserInDB(
            id=str(user["_id"]),
            email=user["email"],
            hashed_password=user["hashed_password"],
            created_at=user["created_at"],
            updated_at=user["updated_at"]
        )
```

### File Locations

**[Source: docs/architecture/unified-project-structure.md]**

Create these files in the backend:
- `backend/src/core/database.py` - MongoDB client and connection
- `backend/src/core/config.py` - Environment variable configuration (if not exists)
- `backend/src/models/user.py` - User Pydantic models
- `backend/src/repositories/user_repository.py` - User database operations
- `backend/src/api/v1/health.py` - Health check endpoint (or add to main.py)
- `backend/tests/conftest.py` - Pytest fixtures
- `backend/tests/test_user_model.py` - User model tests
- `backend/tests/test_user_repository.py` - Repository tests

### Environment Configuration

**[Source: docs/architecture/development-workflow.md]**

**Required Environment Variables:**
```python
# backend/src/core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    MONGODB_URI: str
    DATABASE_NAME: str = "todox"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

Access environment variables only through the `settings` object, never directly via `os.getenv()`.

### Testing

**Test Database Strategy:**
- Use separate MongoDB database or collection for tests
- Configure via `MONGODB_URI_TEST` environment variable or append `_test` to database name
- Reset database before each test class using pytest fixtures

**Required Fixtures (conftest.py):**
```python
import pytest
from motor.motor_asyncio import AsyncIOMotorClient
from httpx import AsyncClient
from src.main import app
from src.core.config import settings

@pytest.fixture
async def test_db():
    client = AsyncIOMotorClient(settings.MONGODB_URI)
    db = client[f"{settings.DATABASE_NAME}_test"]
    yield db
    # Cleanup after tests
    await client.drop_database(f"{settings.DATABASE_NAME}_test")
    client.close()

@pytest.fixture
async def async_client():
    async with AsyncClient(app=app, base_url="http://test") as client:
        yield client
```

**[Source: docs/architecture/testing-strategy.md]**

**Test Coverage Requirements:**
- Unit tests for User model validation
- Unit tests for all repository methods
- Integration test for health check endpoint
- Minimum 80% code coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Story created from Epic 1 | Bob (SM) |
| 2025-09-30 | 1.1 | Database connection and User model implemented | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (Dev Agent - James)

### Debug Log References

**Validation Commands Run:**
- `ruff check src/ tests/` - PASSED (after fixing unused imports)
- `pytest` - NOT RUN (requires MongoDB Atlas connection from Task 1)

**Linting Fixes Applied:**
- Removed unused `Optional` import from `src/models/user.py`
- Removed unused imports from `tests/conftest.py`

### Completion Notes List

**Implementation Summary:**

1. **Configuration Module (Task 2):**
   - Created `src/core/config.py` with Settings class using pydantic-settings
   - Configured all environment variables: MONGODB_URI, DATABASE_NAME, JWT_SECRET, JWT_EXPIRES_IN, JWT_ALGORITHM, CORS_ORIGINS
   - Settings loaded from .env file with case-sensitive keys

2. **Database Client Module (Task 2):**
   - Created `src/core/database.py` with Motor async MongoDB client
   - Configured connection pooling (maxPoolSize=10, minPoolSize=1)
   - Implemented `connect_to_database()` for startup with connection ping test
   - Implemented `close_database_connection()` for shutdown
   - Added `get_database()` dependency function for FastAPI routes
   - Integrated index creation on startup (calls user_repository.ensure_indexes())

3. **Application Lifecycle (Task 2):**
   - Updated `src/main.py` with lifespan context manager
   - Database connects on startup, closes on shutdown
   - Connection verified with admin ping command

4. **User Pydantic Models (Task 3):**
   - Created `src/models/user.py` with all required models:
     - `UserBase`: email field with EmailStr validation
     - `UserCreate`: email + password (min 8 chars) for registration
     - `UserInDB`: complete user with id, hashed_password, timestamps
     - `UserResponse`: safe model for API responses (excludes hashed_password)
   - Pydantic v2 config: `from_attributes = True`

5. **User Repository (Task 4):**
   - Created `src/repositories/user_repository.py` with UserRepository class
   - Implemented `create_user()`: inserts user with timestamps, returns UserInDB
   - Implemented `find_by_email()`: queries by email, returns Optional[UserInDB]
   - Implemented `find_by_id()`: queries by ObjectId, returns Optional[UserInDB]
   - Implemented `ensure_indexes()`: creates unique index on email field
   - All methods properly handle ObjectId ↔ string conversion

6. **Health Check Enhancement (Task 5):**
   - Updated GET /health endpoint in main.py to ping MongoDB
   - Returns `{"status": "healthy", "database": "connected"}` on success
   - Returns 503 with error details if database connection fails

7. **Test Suite (Task 6):**
   - Created `tests/conftest.py` with pytest fixtures:
     - `test_db`: Provides isolated test database (appends `_test` to database name)
     - `async_client`: Provides httpx AsyncClient for API testing
   - Created `tests/test_user_model.py` with 6 validation tests:
     - Valid/invalid email format
     - Password length validation
     - UserInDB field completeness
     - UserResponse excludes password
   - Created `tests/test_user_repository.py` with 6 repository tests:
     - User creation, email lookup, ID lookup
     - Non-existent user handling
     - Email uniqueness enforcement

**Prerequisites for Testing:**
- ⚠️ **Task 1 (User Action Required):** MongoDB Atlas cluster must be provisioned and connection string added to backend/.env before tests can run
- Tests use separate test database (database_name_test) to avoid affecting dev data
- Test database is dropped after each test run for isolation

**Validations Passed:**
- ✅ Ruff linting (after fixing unused imports)
- ⏸️ Pytest tests (blocked by Task 1 - MongoDB setup required)

### File List

**Created:**
- `backend/src/core/config.py` - Application settings with environment variable configuration
- `backend/src/core/database.py` - MongoDB Motor client and connection management
- `backend/src/models/user.py` - User Pydantic models (UserBase, UserCreate, UserInDB, UserResponse)
- `backend/src/repositories/user_repository.py` - User database operations and index management
- `backend/tests/conftest.py` - Pytest fixtures for test database and async client
- `backend/tests/test_user_model.py` - User model validation tests (6 tests)
- `backend/tests/test_user_repository.py` - User repository tests (6 tests)

**Modified:**
- `backend/src/main.py` - Added lifespan manager for database connection, enhanced health check endpoint

## QA Results
_To be populated by QA agent after implementation_
