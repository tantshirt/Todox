# Story 1.2: Database Connection & User Model

## Status
Ready

## Story

**As a** developer,  
**I want** MongoDB Atlas connection established with a User model,  
**so that** we can persist user data securely and query it efficiently.

## Acceptance Criteria

1. MongoDB Atlas cluster is provisioned and connection string available
2. Backend has database client module (`db/client.py`) with connection pooling configured
3. User Pydantic model defined with fields: id, email, hashed_password, created_at, updated_at
4. User repository class (`db/repositories/users_repo.py`) implements methods: create_user, find_by_email, find_by_id
5. Database connection health check endpoint (`GET /health`) returns 200 with database status
6. Unit tests verify User model validation and repository methods using test database
7. Environment variable `MONGODB_URI` properly loads from `.env`

## Tasks / Subtasks

- [ ] Task 1: Provision MongoDB Atlas cluster (User Action) (AC: 1)
  - [ ] User creates free M0 cluster on MongoDB Atlas (https://www.mongodb.com/cloud/atlas/register)
  - [ ] User configures network access (add current IP or 0.0.0.0/0 for development)
  - [ ] User creates database user with username/password
  - [ ] User obtains connection string and adds to `backend/.env` as `MONGODB_URI`
  
- [ ] Task 2: Create database client module (AC: 2, 7)
  - [ ] Create `backend/src/core/database.py`
  - [ ] Implement `get_database()` function that returns AsyncIOMotorDatabase instance
  - [ ] Configure Motor client with connection pooling (max_pool_size=10, min_pool_size=1)
  - [ ] Load `MONGODB_URI` from environment via `src/core/config.py`
  - [ ] Implement startup event in `main.py` to test database connection
  - [ ] Implement shutdown event to close database connection
  
- [ ] Task 3: Define User Pydantic model (AC: 3)
  - [ ] Create `backend/src/models/user.py`
  - [ ] Define `UserBase` Pydantic model with: email (EmailStr, required)
  - [ ] Define `UserCreate` schema with: email, password (min 8 chars)
  - [ ] Define `UserInDB` model extending UserBase with: id (str), hashed_password (str), created_at (datetime), updated_at (datetime)
  - [ ] Define `UserResponse` model (excludes hashed_password) for API responses
  - [ ] Add field validators for email format and password strength
  
- [ ] Task 4: Implement User repository (AC: 4)
  - [ ] Create `backend/src/repositories/user_repository.py`
  - [ ] Implement `UserRepository` class with `__init__(self, db: AsyncIOMotorDatabase)`
  - [ ] Implement `async def create_user(self, email: str, hashed_password: str) -> UserInDB`
  - [ ] Implement `async def find_by_email(self, email: str) -> Optional[UserInDB]`
  - [ ] Implement `async def find_by_id(self, user_id: ObjectId) -> Optional[UserInDB]`
  - [ ] Ensure all methods set created_at and updated_at timestamps
  - [ ] Create unique index on email field in users collection
  
- [ ] Task 5: Create health check endpoint (AC: 5)
  - [ ] Create or update `backend/src/api/v1/health.py` (or add to `main.py`)
  - [ ] Implement `GET /health` endpoint that returns: `{"status": "healthy", "database": "connected"}`
  - [ ] Endpoint should ping MongoDB to verify connection (try a simple query)
  - [ ] Return 503 Service Unavailable if database connection fails
  - [ ] No authentication required for health check
  
- [ ] Task 6: Write unit tests for User model and repository (AC: 6)
  - [ ] Create `backend/tests/conftest.py` with pytest fixtures
  - [ ] Add fixture for test MongoDB database (separate from production)
  - [ ] Add fixture for test client (httpx.AsyncClient)
  - [ ] Create `backend/tests/test_user_model.py`
    - [ ] Test User model validation (valid email, invalid email, short password)
    - [ ] Test UserInDB creation with all fields
  - [ ] Create `backend/tests/test_user_repository.py`
    - [ ] Test create_user inserts document and returns UserInDB
    - [ ] Test find_by_email finds existing user
    - [ ] Test find_by_email returns None for non-existent email
    - [ ] Test find_by_id finds user by ObjectId
    - [ ] Test email uniqueness (duplicate insert fails)

## Dev Notes

### Database Connection Setup

**[Source: docs/architecture/database-schema.md]**

The users collection is the first collection to be created in MongoDB. It stores user authentication credentials and metadata.

**MongoDB Connection Configuration:**
- Use Motor (async MongoDB driver) version 3.3+
- Connection string format: `mongodb+srv://username:password@cluster.mongodb.net/todox?retryWrites=true&w=majority`
- Enable connection pooling with max_pool_size=10, min_pool_size=1
- Database name: `todox` (or configurable via environment)

**Users Collection Schema:**
```json
{
  "_id": ObjectId,
  "email": "user@example.com",
  "hashed_password": "$2b$12$...",
  "created_at": ISODate,
  "updated_at": ISODate
}
```

**Required Indexes:**
- Unique index on `email` field (prevents duplicate registrations)
- Primary key on `_id` (automatic)

### User Data Model

**[Source: docs/architecture/data-models.md#User]**

**Pydantic Models to Create:**

```python
from pydantic import BaseModel, EmailStr, Field
from datetime import datetime
from typing import Optional

class UserBase(BaseModel):
    email: EmailStr

class UserCreate(BaseModel):
    email: EmailStr
    password: str = Field(min_length=8)

class UserInDB(UserBase):
    id: str
    hashed_password: str
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True  # For Pydantic v2

class UserResponse(UserBase):
    id: str
    created_at: datetime
    updated_at: datetime
```

**Key Validations:**
- Email must be valid format (use EmailStr type)
- Password minimum 8 characters
- Never expose hashed_password in responses

### Repository Pattern

**[Source: docs/architecture/backend-architecture.md#Database Architecture]**

All database operations must go through repository classes. Never call MongoDB client directly in services or routes.

**UserRepository Implementation Pattern:**

```python
from motor.motor_asyncio import AsyncIOMotorDatabase
from bson import ObjectId
from datetime import datetime
from typing import Optional

class UserRepository:
    def __init__(self, db: AsyncIOMotorDatabase):
        self.collection = db.users
    
    async def create_user(self, email: str, hashed_password: str) -> UserInDB:
        user_data = {
            "email": email,
            "hashed_password": hashed_password,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        }
        result = await self.collection.insert_one(user_data)
        user_data["_id"] = result.inserted_id
        return UserInDB(
            id=str(user_data["_id"]),
            email=user_data["email"],
            hashed_password=user_data["hashed_password"],
            created_at=user_data["created_at"],
            updated_at=user_data["updated_at"]
        )
    
    async def find_by_email(self, email: str) -> Optional[UserInDB]:
        user = await self.collection.find_one({"email": email})
        if not user:
            return None
        return UserInDB(
            id=str(user["_id"]),
            email=user["email"],
            hashed_password=user["hashed_password"],
            created_at=user["created_at"],
            updated_at=user["updated_at"]
        )
```

### File Locations

**[Source: docs/architecture/unified-project-structure.md]**

Create these files in the backend:
- `backend/src/core/database.py` - MongoDB client and connection
- `backend/src/core/config.py` - Environment variable configuration (if not exists)
- `backend/src/models/user.py` - User Pydantic models
- `backend/src/repositories/user_repository.py` - User database operations
- `backend/src/api/v1/health.py` - Health check endpoint (or add to main.py)
- `backend/tests/conftest.py` - Pytest fixtures
- `backend/tests/test_user_model.py` - User model tests
- `backend/tests/test_user_repository.py` - Repository tests

### Environment Configuration

**[Source: docs/architecture/development-workflow.md]**

**Required Environment Variables:**
```python
# backend/src/core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    MONGODB_URI: str
    DATABASE_NAME: str = "todox"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

Access environment variables only through the `settings` object, never directly via `os.getenv()`.

### Testing

**Test Database Strategy:**
- Use separate MongoDB database or collection for tests
- Configure via `MONGODB_URI_TEST` environment variable or append `_test` to database name
- Reset database before each test class using pytest fixtures

**Required Fixtures (conftest.py):**
```python
import pytest
from motor.motor_asyncio import AsyncIOMotorClient
from httpx import AsyncClient
from src.main import app
from src.core.config import settings

@pytest.fixture
async def test_db():
    client = AsyncIOMotorClient(settings.MONGODB_URI)
    db = client[f"{settings.DATABASE_NAME}_test"]
    yield db
    # Cleanup after tests
    await client.drop_database(f"{settings.DATABASE_NAME}_test")
    client.close()

@pytest.fixture
async def async_client():
    async with AsyncClient(app=app, base_url="http://test") as client:
        yield client
```

**[Source: docs/architecture/testing-strategy.md]**

**Test Coverage Requirements:**
- Unit tests for User model validation
- Unit tests for all repository methods
- Integration test for health check endpoint
- Minimum 80% code coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Story created from Epic 1 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent after implementation_
