# Story 1.3: User Registration API

## Status
Ready

## Story

**As a** new user,  
**I want** to register with email and password,  
**so that** I can create an account and access the application.

## Acceptance Criteria

1. API endpoint `POST /auth/register` accepts JSON body with email and password
2. Password must be at least 8 characters and validated with Pydantic
3. Email must be valid format and unique (return 409 Conflict if already exists)
4. Password is hashed using bcrypt before storing in database
5. Successful registration returns 201 status with JSON response containing user id and email (no password)
6. Registration fails with clear error messages for: invalid email format, weak password, duplicate email
7. Unit tests cover: successful registration, duplicate email rejection, validation errors
8. Endpoint is documented and accessible

## Tasks / Subtasks

- [ ] Task 1: Create authentication schemas (AC: 1, 2, 6)
  - [ ] Create `backend/src/schemas/auth.py`
  - [ ] Define `RegisterRequest` schema with email (EmailStr) and password (min_length=8)
  - [ ] Define `UserResponse` schema with id, email, created_at, updated_at (no password fields)
  - [ ] Add Pydantic validators for password strength and email format

- [ ] Task 2: Implement password hashing utility (AC: 4)
  - [ ] Create `backend/src/core/security.py`
  - [ ] Import `passlib.context.CryptContext`
  - [ ] Create `pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")`
  - [ ] Implement `hash_password(password: str) -> str` function using bcrypt with cost factor 12
  - [ ] Implement `verify_password(plain_password: str, hashed_password: str) -> bool` function

- [ ] Task 3: Create authentication service (AC: 4, 5)
  - [ ] Create `backend/src/services/auth_service.py`
  - [ ] Implement `AuthService` class
  - [ ] Implement `async def register_user(self, email: str, password: str) -> UserResponse` method
  - [ ] Method should: check if email exists (raise 409 if exists), hash password, call user_repository.create_user(), return UserResponse
  - [ ] Use dependency injection for UserRepository

- [ ] Task 4: Create registration route (AC: 1, 3, 5, 6)
  - [ ] Create `backend/src/api/v1/auth.py`
  - [ ] Import FastAPI router, HTTPException, status codes
  - [ ] Create router with prefix="/auth"
  - [ ] Implement `POST /auth/register` endpoint
  - [ ] Endpoint accepts RegisterRequest body
  - [ ] Call auth_service.register_user()
  - [ ] Handle duplicate email: catch exception, return 409 with detail "Email already registered"
  - [ ] Return 201 status with UserResponse on success
  - [ ] Include endpoint in main.py router

- [ ] Task 5: Write unit tests (AC: 7)
  - [ ] Create `backend/tests/test_auth.py`
  - [ ] Test successful registration: valid email/password → 201 with user data
  - [ ] Test duplicate email: register twice with same email → second returns 409
  - [ ] Test invalid email format: invalid email → 422 validation error
  - [ ] Test weak password: password < 8 chars → 422 validation error
  - [ ] Test password is hashed: verify hashed_password != plain password
  - [ ] Test password never returned: UserResponse excludes hashed_password field

- [ ] Task 6: Manual endpoint testing (AC: 8)
  - [ ] Start backend server: `uvicorn src.main:app --reload`
  - [ ] Test POST /auth/register with curl or Postman
  - [ ] Verify OpenAPI docs at http://localhost:8000/docs show the endpoint
  - [ ] Test various invalid inputs to confirm error handling

## Dev Notes

### User Registration Flow

**[Source: docs/architecture/core-workflows.md#User Registration and First Task Creation]**

The registration flow follows this sequence:
1. Frontend sends POST request with email and password
2. Backend validates with Pydantic (email format, password length)
3. Backend checks if email already exists (return 409 if duplicate)
4. Backend hashes password using bcrypt
5. Backend inserts user document into MongoDB
6. Backend returns 201 with user object (excludes password)

### Security Implementation

**[Source: docs/architecture/backend-architecture.md#Authentication and Authorization]**

**Password Hashing:**
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    """Hash a password using bcrypt with cost factor 12."""
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """Verify a password against its hash."""
    return pwd_context.verify(plain_password, hashed_password)
```

**Critical Security Rules:**
- **NEVER** log or display passwords
- **ALWAYS** hash before storing (use hash_password function)
- **NEVER** return hashed_password in API responses
- Use bcrypt cost factor of 12 minimum (default is acceptable)

**[Source: docs/architecture/coding-standards.md#Password Handling]**

### Error Handling

**[Source: docs/architecture/error-handling-strategy.md]**

Use FastAPI's HTTPException for all errors:

```python
from fastapi import HTTPException, status

# Duplicate email
raise HTTPException(
    status_code=status.HTTP_409_CONFLICT,
    detail="Email already registered"
)

# Validation errors handled automatically by Pydantic
```

### API Specification

**[Source: docs/architecture/api-specification.md]**

**Endpoint:** `POST /auth/register`

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

**Success Response (201 Created):**
```json
{
  "id": "507f1f77bcf86cd799439011",
  "email": "user@example.com",
  "created_at": "2025-01-12T10:00:00Z",
  "updated_at": "2025-01-12T10:00:00Z"
}
```

**Error Responses:**
- 400 Bad Request: Invalid email format or password too short
- 409 Conflict: Email already exists
- 422 Unprocessable Entity: Pydantic validation failure

### File Locations

**[Source: docs/architecture/backend-architecture.md#Controller/Route Organization]**

Create these files:
- `backend/src/core/security.py` - Password hashing utilities
- `backend/src/schemas/auth.py` - Registration/login request/response schemas
- `backend/src/services/auth_service.py` - Authentication business logic
- `backend/src/api/v1/auth.py` - Authentication routes
- `backend/tests/test_auth.py` - Integration tests for auth endpoints

### Dependency Injection Pattern

**[Source: docs/architecture/backend-architecture.md#Controller Template]**

FastAPI uses dependency injection. Routes should depend on services:

```python
from fastapi import Depends

def get_auth_service(db = Depends(get_database)) -> AuthService:
    return AuthService(UserRepository(db))

@router.post("/register")
async def register(
    data: RegisterRequest,
    auth_service: AuthService = Depends(get_auth_service)
):
    return await auth_service.register_user(data.email, data.password)
```

### Testing

**[Source: docs/architecture/testing-strategy.md]**

**Test Organization:**
- Backend auth tests: `backend/tests/test_auth.py`
- Use pytest with async support (`@pytest.mark.asyncio`)
- Use test database separate from development database

**Test Examples:**

```python
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_register_success(async_client: AsyncClient):
    response = await async_client.post(
        "/auth/register",
        json={"email": "new@example.com", "password": "password123"}
    )
    assert response.status_code == 201
    data = response.json()
    assert data["email"] == "new@example.com"
    assert "hashed_password" not in data
    assert "id" in data

@pytest.mark.asyncio  
async def test_register_duplicate_email(async_client: AsyncClient):
    # Register first user
    await async_client.post(
        "/auth/register",
        json={"email": "duplicate@example.com", "password": "password123"}
    )
    # Try to register again
    response = await async_client.post(
        "/auth/register",
        json={"email": "duplicate@example.com", "password": "password123"}
    )
    assert response.status_code == 409
```

**Coverage Requirements:** Minimum 80% code coverage for authentication service and routes.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Story created from Epic 1 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent after implementation_
