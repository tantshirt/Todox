# Story 2.2: Create Task API

## Status
Ready

## Story

**As a** user,  
**I want** to create a new task with title, priority, and deadline,  
**so that** I can track my todos with proper organization.

## Acceptance Criteria

1. API endpoint `POST /tasks` accepts JSON body with: title (required), description (optional), priority (required, enum), deadline (required, ISO date)
2. Endpoint requires authentication and associates task with authenticated user's owner_id
3. New task defaults to status "open" and empty label_ids array
4. Successful creation returns 201 status with complete Task object
5. Validation errors return 400 with clear messages for: missing title, invalid priority, invalid deadline format
6. Unit tests cover: successful creation, validation errors, authentication requirement
7. Task service module (`services/task_service.py`) implements business logic for task creation

## Tasks / Subtasks

- [ ] Task 1: Create Task service (AC: 2, 3, 7)
  - [ ] Create `backend/src/services/task_service.py`
  - [ ] Implement `TaskService` class with `__init__(self, task_repository: TaskRepository)`
  - [ ] Implement `async def create_task(self, owner_id: str, task_data: TaskCreate) -> TaskResponse`
  - [ ] Method converts task_data to dict, adds owner_id, calls repository.create_task()
  - [ ] Ensure status defaults to 'open' and label_ids defaults to []
  - [ ] Return TaskResponse

- [ ] Task 2: Create POST /tasks route (AC: 1, 2, 4, 5)
  - [ ] Create `backend/src/api/v1/tasks.py`
  - [ ] Create router with prefix="/tasks"
  - [ ] Implement `POST /tasks` endpoint with `current_user = Depends(get_current_user)`
  - [ ] Accept `task_data: TaskCreate` request body
  - [ ] Call task_service.create_task(current_user.id, task_data)
  - [ ] Return 201 status with TaskResponse
  - [ ] Pydantic automatically handles validation errors (422/400 responses)
  - [ ] Include router in main.py

- [ ] Task 3: Write unit tests (AC: 6)
  - [ ] Create `backend/tests/test_tasks.py`
  - [ ] Test successful creation: POST with valid data → 201 with task object
  - [ ] Test authentication required: POST without token → 401
  - [ ] Test missing title: POST without title → 422 validation error
  - [ ] Test invalid priority: POST with priority="Invalid" → 422
  - [ ] Test invalid deadline: POST with deadline="not-a-date" → 422
  - [ ] Test defaults: verify status='open' and label_ids=[] in created task
  - [ ] Test owner_id: verify created task has owner_id matching authenticated user

## Dev Notes

### API Specification

**[Source: docs/architecture/api-specification.md#POST /tasks]**

**Endpoint:** `POST /tasks`  
**Authentication:** Required (Bearer token)

**Request Body:**
```json
{
  "title": "Complete project",
  "description": "Write all documentation",
  "priority": "High",
  "deadline": "2025-01-20",
  "label_ids": []
}
```

**Success Response (201 Created):**
```json
{
  "id": "507f191e810c19729de860ea",
  "title": "Complete project",
  "description": "Write all documentation",
  "priority": "High",
  "deadline": "2025-01-20",
  "status": "open",
  "label_ids": [],
  "owner_id": "507f1f77bcf86cd799439011",
  "created_at": "2025-01-12T15:30:00Z",
  "updated_at": "2025-01-12T15:30:00Z"
}
```

**Error Responses:**
- 400/422: Validation error (missing title, invalid priority/deadline)
- 401: Unauthorized (missing or invalid token)

### Service Layer Pattern

**[Source: docs/architecture/backend-architecture.md#Controller Template]**

Services contain business logic. Controllers (routes) are thin and delegate to services.

**TaskService Implementation:**

```python
from src.repositories.task_repository import TaskRepository
from src.models.task import TaskCreate, TaskResponse, TaskInDB
from bson import ObjectId

class TaskService:
    def __init__(self, task_repository: TaskRepository):
        self.task_repo = task_repository
    
    async def create_task(self, owner_id: str, task_data: TaskCreate) -> TaskResponse:
        """Create a new task for the authenticated user."""
        task_dict = task_data.model_dump()
        task_dict['owner_id'] = ObjectId(owner_id)
        
        task = await self.task_repo.create_task(task_dict)
        return TaskResponse(**task.model_dump())
```

**Route with Dependency Injection:**

```python
from fastapi import APIRouter, Depends, status
from src.middleware.auth_middleware import get_current_user
from src.schemas.task import TaskCreate, TaskResponse

router = APIRouter(prefix="/tasks", tags=["tasks"])

def get_task_service(db = Depends(get_database)) -> TaskService:
    return TaskService(TaskRepository(db))

@router.post("/", response_model=TaskResponse, status_code=status.HTTP_201_CREATED)
async def create_task(
    task_data: TaskCreate,
    current_user: User = Depends(get_current_user),
    task_service: TaskService = Depends(get_task_service)
):
    """Create a new task."""
    return await task_service.create_task(current_user.id, task_data)
```

### Critical Security Rule

**[Source: docs/architecture/coding-standards.md#Authentication]**

**CRITICAL:** The `owner_id` MUST come from the authenticated user (`current_user.id`), NEVER from the request body.

```python
# CORRECT:
task_dict['owner_id'] = ObjectId(current_user.id)

# WRONG - Security vulnerability!
task_dict['owner_id'] = ObjectId(task_data.owner_id)
```

This prevents users from creating tasks for other users.

### File Locations

**[Source: docs/architecture/backend-architecture.md]**

Create these files:
- `backend/src/services/task_service.py` - Task business logic
- `backend/src/api/v1/tasks.py` - Task routes
- `backend/tests/test_tasks.py` - Task API integration tests

Update:
- `backend/src/main.py` - Include tasks router

### Testing

**[Source: docs/architecture/testing-strategy.md#Backend API Test]**

**Integration Test Example:**

```python
@pytest.mark.asyncio
async def test_create_task(async_client: AsyncClient, auth_headers: dict):
    """Test creating a new task."""
    task_data = {
        "title": "Test Task",
        "priority": "High",
        "deadline": "2025-01-15",
        "description": "Test description"
    }
    
    response = await async_client.post(
        "/tasks",
        json=task_data,
        headers=auth_headers
    )
    
    assert response.status_code == 201
    data = response.json()
    assert data["title"] == "Test Task"
    assert data["priority"] == "High"
    assert data["status"] == "open"
    assert data["label_ids"] == []
    assert "id" in data
    assert "owner_id" in data
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Story created from Epic 2 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent after implementation_
