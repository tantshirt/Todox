# Story 1.8: Deployment to Railway & Vercel

## Status
Ready for Review

## Story

**As a** developer,  
**I want** the application deployed to production environments,  
**so that** the live application is accessible and users can test it.

## Acceptance Criteria

1. Backend deployed to Railway with environment variables configured: `MONGODB_URI`, `JWT_SECRET`, `JWT_EXPIRES_IN`, `CORS_ORIGINS`
2. Railway service exposes backend URL (e.g., `https://todox-backend.up.railway.app`)
3. Frontend deployed to Vercel with environment variable `NEXT_PUBLIC_API_URL` pointing to Railway backend URL
4. Vercel deployment accessible at public URL (e.g., `https://todox.vercel.app`)
5. Health check endpoint (`GET /health`) returns 200 on Railway deployment
6. Frontend login page loads successfully on Vercel
7. End-to-end flow verified: register on production → login on production → access dashboard
8. Deployment documented in README with links to live URLs

## Tasks / Subtasks

- [ ] Task 1: Deploy backend to Railway (User Action) (AC: 1, 2, 5)
  - [ ] User creates Railway account at https://railway.app
  - [ ] User creates new project in Railway
  - [ ] User connects GitHub repository to Railway project
  - [ ] Railway automatically detects Python and FastAPI
  - [ ] User configures environment variables in Railway dashboard:
    - [ ] `MONGODB_URI` - MongoDB Atlas connection string
    - [ ] `JWT_SECRET` - Strong secret key (same as local or new)
    - [ ] `JWT_EXPIRES_IN` - 3600 (or desired value)
    - [ ] `JWT_ALGORITHM` - HS256
    - [ ] `CORS_ORIGINS` - https://todox.vercel.app (update after Vercel deploy)
  - [ ] Railway automatically deploys on push to main or on tag
  - [ ] User notes the Railway backend URL (e.g., https://todox-backend.up.railway.app)
  - [ ] Test health check: `curl https://todox-backend.up.railway.app/health`

- [ ] Task 2: Configure backend for Railway deployment (AC: 1)
  - [ ] Create `backend/Procfile` with: `web: uvicorn src.main:app --host 0.0.0.0 --port $PORT`
  - [ ] OR rely on Railway's automatic Nixpacks detection (no Procfile needed for FastAPI)
  - [ ] Verify `requirements.txt` includes all dependencies
  - [ ] Ensure `src/main.py` binds to `0.0.0.0` and respects `PORT` env var if provided

- [ ] Task 3: Deploy frontend to Vercel (User Action) (AC: 3, 4, 6)
  - [ ] User creates Vercel account at https://vercel.com
  - [ ] User imports GitHub repository in Vercel
  - [ ] Vercel automatically detects Next.js
  - [ ] User sets root directory to `frontend` in Vercel project settings
  - [ ] User configures environment variable in Vercel:
    - [ ] `NEXT_PUBLIC_API_URL` - Railway backend URL (e.g., https://todox-backend.up.railway.app)
  - [ ] Vercel automatically deploys on push to main
  - [ ] User notes Vercel URL (e.g., https://todox.vercel.app)
  - [ ] Test frontend loads: visit Vercel URL in browser

- [ ] Task 4: Update CORS_ORIGINS on Railway (AC: 1)
  - [ ] User updates CORS_ORIGINS environment variable on Railway to include Vercel URL
  - [ ] New value: `https://todox.vercel.app` (or comma-separated if multiple origins)
  - [ ] Railway redeploys automatically on env var change

- [ ] Task 5: Create E2E test setup and basic smoke test (AC: 7)
  - [ ] Create `e2e/` directory at project root
  - [ ] Run `npm init -y` in e2e/ to create package.json
  - [ ] Install Playwright: `npm install -D @playwright/test`
  - [ ] Run `npx playwright install` to install browsers
  - [ ] Create `e2e/playwright.config.ts` with:
    - [ ] `baseURL: process.env.E2E_BASE_URL || 'http://localhost:3000'`
    - [ ] Test directory: `./tests`
    - [ ] Projects for chromium, firefox, webkit
  - [ ] Create `e2e/tests/auth.spec.ts`
  - [ ] Write smoke test: register → login → verify dashboard loads
  - [ ] Test should work against both local and production URLs

- [ ] Task 6: Run production smoke test (AC: 7)
  - [ ] Set E2E_BASE_URL to Vercel production URL
  - [ ] Run `npx playwright test` from e2e/ directory
  - [ ] Verify: Registration works, login works, dashboard accessible
  - [ ] Debug any CORS or environment variable issues

- [ ] Task 7: Update README with deployment information (AC: 8)
  - [ ] Update root `README.md`
  - [ ] Add "Deployment" section with:
    - [ ] Live URLs: Frontend (Vercel), Backend (Railway)
    - [ ] Deployment instructions for Railway and Vercel
    - [ ] Environment variable requirements for each platform
  - [ ] Add "Architecture" section linking to docs/architecture.md

## Dev Notes

### Railway Deployment

**[Source: docs/architecture/deployment-architecture.md#Deployment Strategy]**

**Backend Deployment Configuration:**
- **Platform:** Railway
- **Auto-Detection:** Railway uses Nixpacks to automatically detect FastAPI
- **Build Command:** Automatic (`pip install -r requirements.txt`)
- **Start Command:** `uvicorn src.main:app --host 0.0.0.0 --port $PORT`
- **Environment:** Railway injects `PORT` variable, FastAPI must bind to it

**Required Environment Variables:**
```
MONGODB_URI=mongodb+srv://...
JWT_SECRET=your-production-secret-32-chars-minimum
JWT_EXPIRES_IN=3600
JWT_ALGORITHM=HS256
CORS_ORIGINS=https://todox.vercel.app
```

**Railway Features:**
- Automatic HTTPS
- Environment variable management via dashboard
- Deployment on git push or tag
- Log streaming and monitoring

### Vercel Deployment

**[Source: docs/architecture/deployment-architecture.md#Deployment Strategy]**

**Frontend Deployment Configuration:**
- **Platform:** Vercel
- **Build Command:** `npm run build` (automatic)
- **Output Directory:** `.next` (automatic)
- **Root Directory:** `frontend/` (must be configured in project settings)
- **Framework Preset:** Next.js (auto-detected)

**Required Environment Variables:**
```
NEXT_PUBLIC_API_URL=https://todox-backend.up.railway.app
```

**Vercel Features:**
- Global Edge Network CDN
- Automatic deployments on push to main
- Preview URLs for pull requests
- Environment variables per environment (production, preview, development)

### CORS Configuration for Production

**[Source: docs/architecture/security-and-performance.md#CORS Policy]**

After deploying to Vercel, update Railway's CORS_ORIGINS to match:

```
CORS_ORIGINS=https://todox.vercel.app
```

**For multiple origins (dev + prod):**
```
CORS_ORIGINS=http://localhost:3000,https://todox.vercel.app
```

The backend CORS middleware will split by comma and allow all listed origins.

### Playwright E2E Test Setup

**[Source: docs/architecture/testing-strategy.md#E2E Tests]**

**Playwright Configuration:**

```typescript
// e2e/playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  timeout: 30000,
  retries: 2,
  use: {
    baseURL: process.env.E2E_BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    video: 'retain-on-failure',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
  ],
});
```

**Basic Smoke Test Example:**

```typescript
// e2e/tests/auth.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Production Smoke Test', () => {
  test('complete auth flow works', async ({ page }) => {
    const timestamp = Date.now();
    const testEmail = `test-${timestamp}@example.com`;
    
    // Registration
    await page.goto('/auth/register');
    await page.fill('input[type="email"]', testEmail);
    await page.fill('input[type="password"]', 'testpassword123');
    await page.click('button[type="submit"]');
    
    // Should redirect to login
    await page.waitForURL('/auth/login');
    await expect(page.locator('text=/success/i')).toBeVisible();
    
    // Login
    await page.fill('input[type="email"]', testEmail);
    await page.fill('input[type="password"]', 'testpassword123');
    await page.click('button[type="submit"]');
    
    // Should redirect to dashboard
    await page.waitForURL('/tasks');
    await expect(page.locator('text=/tasks/i')).toBeVisible();
  });
});
```

### File Locations

**[Source: docs/architecture/unified-project-structure.md]**

Create these files:
- `e2e/package.json` - E2E test dependencies
- `e2e/playwright.config.ts` - Playwright configuration
- `e2e/tests/auth.spec.ts` - Auth flow smoke tests
- `backend/Procfile` - Railway start command (optional, Nixpacks auto-detects)
- Update root `README.md` - Deployment section

### Deployment Verification Checklist

After deployment, verify:
- ✓ Railway backend health check returns 200
- ✓ Vercel frontend loads login page
- ✓ Frontend can make API calls to backend (no CORS errors)
- ✓ Registration flow works end-to-end
- ✓ Login flow works end-to-end
- ✓ JWT authentication works
- ✓ Protected routes redirect when not authenticated

### Testing

**[Source: docs/architecture/testing-strategy.md#E2E Test]**

**Test Organization:**
- E2E tests: `e2e/tests/`
- Run locally: `npx playwright test --headed` (shows browser)
- Run in CI: `npx playwright test` (headless)
- Trace recording: `npx playwright test --trace on`

**Environment-Specific Testing:**
```bash
# Test against local
npm run dev  # Start frontend
E2E_BASE_URL=http://localhost:3000 npx playwright test

# Test against production
E2E_BASE_URL=https://todox.vercel.app npx playwright test
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Story created from Epic 1 | Bob (SM) |
| 2025-09-30 | 1.1 | Deployment configuration and E2E tests created | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (Dev Agent - James)

### Debug Log References

**Completed Tasks:**
- Created backend Procfile for Railway
- Set up E2E test infrastructure with Playwright
- Created comprehensive smoke tests (3 test scenarios)
- Updated README with detailed deployment instructions

**User Action Required:**
- Railway account creation and backend deployment
- Vercel account creation and frontend deployment  
- Environment variable configuration on both platforms
- Production smoke test execution

### Completion Notes List

**Implementation Summary:**

1. **Backend Railway Configuration (Task 2):**
   - Created `backend/Procfile` with uvicorn start command
   - Procfile binds to 0.0.0.0 and respects Railway's $PORT variable
   - requirements.txt already includes all dependencies
   - Backend is ready for Railway deployment

2. **E2E Test Setup (Task 5):**
   - Created `e2e/` directory with proper structure
   - Installed Playwright with chromium browser
   - Created `e2e/playwright.config.ts` with:
     - Configurable baseURL (defaults to localhost:3000)
     - 3 browser projects (chromium, firefox, webkit)
     - Trace and video capture on failure
     - 2 retries for flaky tests
   - Created `e2e/tests/auth.spec.ts` with 3 comprehensive tests:
     - Complete auth flow (register → login → protected access → logout)
     - Protected route redirect test
     - Validation error display test
   - Added test scripts to package.json (test, test:headed, test:ui)

3. **README Documentation (Task 7):**
   - Added comprehensive "Deployment" section
   - Step-by-step Railway deployment guide
   - Step-by-step Vercel deployment guide
   - Environment variable requirements clearly listed
   - CORS configuration instructions
   - E2E testing commands

**Deployment Ready:**
- ✅ Backend configured for Railway (Procfile + requirements.txt)
- ✅ Frontend ready for Vercel (Next.js auto-detected)
- ✅ E2E tests created for production validation
- ✅ Documentation complete

**Next Steps for User:**
The following tasks require user accounts and manual steps:

**Task 1: Deploy to Railway**
1. Create account at https://railway.app
2. Create new project, connect GitHub repo
3. Configure environment variables (see README)
4. Note Railway URL

**Task 3: Deploy to Vercel**
1. Create account at https://vercel.com  
2. Import GitHub repository
3. Set root directory to `frontend`
4. Configure NEXT_PUBLIC_API_URL with Railway URL
5. Note Vercel URL

**Task 4: Update CORS**
1. Update Railway CORS_ORIGINS to include Vercel URL

**Task 6: Run E2E Tests**
1. `E2E_BASE_URL=https://your-vercel-url.vercel.app npm test` from e2e/

### File List

**Created:**
- `backend/Procfile` - Railway start command configuration
- `e2e/package.json` - E2E test package configuration
- `e2e/playwright.config.ts` - Playwright test configuration
- `e2e/tests/auth.spec.ts` - Authentication flow E2E tests (3 scenarios)

**Modified:**
- `README.md` - Added comprehensive deployment section with step-by-step guides

## QA Results
_To be populated by QA agent after implementation_
